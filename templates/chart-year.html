<!DOCTYPE html>
<html>
<head>
    <title>DrawResult Winning Numbers Visualization</title>
    <style>
        /* Include necessary CSS styles */
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 4px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1>DrawResult Winning Numbers Visualization</h1>
    <form id="filter-form">
        <label for="year-select">Filter by Year:</label>
        <select id="year-select" name="year">
            <option value="">All</option>
            {% for filter in filters %}
                <option value="{{ filter }}">{{ filter }}</option>
            {% endfor %}
        </select>
        <label for="day-select">Filter by Day:</label>
        <select id="day-select" name="day">
            <option value="">All</option>
            <option value="Monday">Monday</option>
            <option value="Wednesday">Wednesday</option>
        </select>
        <button type="button" id="filter-button">Filter</button>
    </form>
    <svg id="chart"></svg>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // Access the passed data
        var drawResults = JSON.parse('{{ draw_results | tojson | safe }}') || [];

        // Function to filter data based on selected year and day
        function applyFilter() {
            var selectedYear = document.getElementById("year-select").value;
            var selectedDay = document.getElementById("day-select").value;
            var filteredResults;

            if (selectedYear || selectedDay) {
                filteredResults = drawResults.filter(function(result) {
                    if (selectedYear && selectedDay) {
                        var year = new Date(result.draw_date).getFullYear();
                        var day = new Date(result.draw_date).toLocaleDateString('en-US', { weekday: 'long' });
                        return year === parseInt(selectedYear) && day === selectedDay;
                    } else if (selectedYear) {
                        var year = new Date(result.draw_date).getFullYear();
                        return year === parseInt(selectedYear);
                    } else if (selectedDay) {
                        var day = new Date(result.draw_date).toLocaleDateString('en-US', { weekday: 'long' });
                        return day === selectedDay;
                    }
                });
            } else {
                filteredResults = drawResults;
            }

            // Calculate the frequency of winning numbers
            var frequency = {};
            filteredResults.forEach(function(result) {
                result.primary_numbers.forEach(function(number) {
                    if (number in frequency) {
                        frequency[number] += 1;
                    } else {
                        frequency[number] = 1;
                    }
                });
                result.secondary_numbers.forEach(function(number) {
                    if (number in frequency) {
                        frequency[number] += 1;
                    } else {
                        frequency[number] = 1;
                    }
                });
            });

            // Generate chart using the filtered results and frequency
            generateChart(frequency);
        }

        // Generate the initial chart with all drawResults
        function generateChart(data) {
            // Sort the data by frequency in descending order
            var sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);

            // Set up the chart dimensions
            var margin = { top: 20, right: 20, bottom: 30, left: 40 };
            var width = 800 - margin.left - margin.right;
            var height = 400 - margin.top - margin.bottom;

            // Remove the existing SVG element
            d3.select("#chart").selectAll("*").remove();

            // Create the SVG container
            var svg = d3.select("#chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Set up the x and y scales
            var x = d3.scaleBand()
                .domain(sortedData.map(d => d[0]))
                .range([0, width])
                .padding(0.1);

            var y = d3.scaleLinear()
                .domain([0, d3.max(sortedData, d => d[1])])
                .range([height, 0]);

            // Create the bars
            var bars = svg.selectAll(".bar")
                .data(sortedData)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", function (d) { return x(d[0]); })
                .attr("width", x.bandwidth())
                .attr("y", function (d) { return y(d[1]); })
                .attr("height", function (d) { return height - y(d[1]); });

            // Add tooltip for hover
            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Add hover listeners
            bars.on("mouseover", function (event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    tooltip.html("Frequency: " + d[1])
                        .style("left", event.pageX + "px")
                        .style("top", event.pageY - 28 + "px");
                    d3.select(this)
                        .attr("fill", "orange");
                })
                .on("mouseout", function () {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                    d3.select(this)
                        .attr("fill", "black");
                });
        

            // Add x-axis
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x));

            // Add y-axis
            svg.append("g")
                .call(d3.axisLeft(y));
        }

        // Add event listener for filter button click
        document.getElementById("filter-button").addEventListener("click", applyFilter);

        // Generate the initial chart with all drawResults
        generateChart({});
    </script>
</body>
</html>
